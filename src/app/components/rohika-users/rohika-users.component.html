<div class="container mt-4">
  <div class="d-flex align-items-center mb-3" style="gap: 10px;">
    <h2 class="mb-3">Orders</h2>
    <!-- Year Filter -->
    <select class="form-select w-auto" [(ngModel)]="selectedYear" (change)="onFilterChange()">
      <option value="">All Years</option>
      <option *ngFor="let year of years">{{ year }}</option>
    </select>

    <!-- Month Filter -->
    <select class="form-select w-auto" [(ngModel)]="selectedMonth" (change)="onFilterChange()">
      <option value="">All Months</option>
      <option *ngFor="let m of months" [value]="m.value">{{ m.name }}</option>
    </select>

  </div>


  <button class="btn btn-secondary" (click)="toggleView()">
    <i class="bi" [ngClass]="cardView ? 'bi-list' : 'bi-grid'"></i>
    {{ cardView ? 'Switch to List View' : 'Switch to Card View' }}
  </button>

  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#printModalBulk" (click)="printLabels(true)"
    style="margin-left: 15px;">
    <i class="bi bi-printer"></i> Print Labels
  </button>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#printModalBulk" (click)="printLabels(false)"
    style="margin-left: 15px;">
    <i class="bi bi-printer"></i> Print Bills
  </button>

  <button class="btn btn-warning" (click)="toggleSelectAll(null)" style="margin-left: 15px;">
    Reset Selection
  </button>


  <span style="float: right;">Current Month Orders:: {{users.length}}</span>

  <input type="text" class="form-control mb-3" style="margin-top: 20px;" [(ngModel)]="searchText"
    placeholder="Search...">


  <div *ngIf="!cardView">
    <div class="table-responsive" style="max-height: 75vh; overflow-y: auto;">
      <table class="table table-bordered table-striped">
        <thead class="table-dark position-sticky top-0">
          <tr>
            <th>
              <input type="checkbox" (change)="toggleSelectAll($event)">
            </th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Name" [(ngModel)]="filters.name">
            </th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Order No"
                [(ngModel)]="filters.aliasName"></th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Phone" [(ngModel)]="filters.phone">
            </th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Address"
                [(ngModel)]="filters.address"></th>
            <th><input type="text" class="form-control form-control-sm" placeholder="City" [(ngModel)]="filters.city">
            </th>
            <th><input type="text" class="form-control form-control-sm" placeholder="State" [(ngModel)]="filters.state">
            </th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Country"
                [(ngModel)]="filters.country"></th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Pincode"
                [(ngModel)]="filters.pincode"></th>
            <th><input type="date" class="form-control form-control-sm" [(ngModel)]="filters.createdAt"></th>
            <th></th>
          </tr>
        </thead>
        <tbody *ngIf="users.length > 0">
          <tr *ngFor="let user of users | tableSearch: searchText | tableFilter: filters">
            <td>
              <input type="checkbox" [checked]="isSelected(user.id)" (change)="toggleSelection(user.id)">
            </td>
            <td>{{ user.name }}</td>
            <td>{{ user.aliasName }}</td>
            <td><span *ngIf="user.phone!=1111111111">{{ user.phone }}</span></td>
            <td>{{ user.address }}</td>
            <td>{{ user.city }}</td>
            <td>{{ user.state }}</td>
            <td>{{ user.country }}</td>
            <td>{{ user.pincode }}</td>
            <td>{{ user.createdAt | date }}</td>
            <td style="display: inline-flex;">
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#myModal"
                (click)="getItemsListByUser(user.id)">
                <i class="bi bi-info-circle"></i>
              </button>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#printModal"
                (click)="setUser(user)" style="margin-left: 5px;">
                <i class="bi bi-printer"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div *ngIf="cardView">
    <!-- Responsive Cards Grid -->
    <div class="row">
      <div class="col-md-4 mb-3" *ngFor="let user of users | tableSearch: searchText">
        <div class="card shadow-lg p-3 mb-5 bg-white rounded">
          <div class="card-body" style="background-color: antiquewhite;">
            <div class="d-flex align-items-center">
              <input type="checkbox" [checked]="isSelected(user.id)" [id]="user.id" (change)="toggleSelection(user.id)"
                class="me-2">
              <label class="card-title mb-0" [for]="user.id">{{ user.name }}</label>
              <button class="btn btn-link ms-auto p-0" title="Edit Address" data-bs-toggle="modal"
                data-bs-target="#editModal" (click)="selectUser(user)">
                <i class="bi bi-pencil-square"></i>
              </button>
            </div>
            <p class="card-text"><strong>Order No:</strong> {{ user.aliasName }}</p>
            <p class="card-text"><strong>Phone:</strong> <span *ngIf="user.phone!=1111111111">{{ user.phone }}</span>
            </p>
            <p class="card-text" style="min-height: 48px;"><strong>Address:</strong><span *ngIf="user.address"> {{
                user.address }}, {{ user.city }}, {{ user.state }}</span></p>
            <p class="card-text"><strong>Pincode:</strong> {{ user.pincode }}</p>
            <p class="card-text"><strong>Created At:</strong> {{ user.createdAt | date }}</p>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between">
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#myModal"
                (click)="getItemsListByUser(user.id)">
                <i class="bi bi-info-circle"></i> Details
              </button>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#printModal"
                (click)="setUser(user)">
                <i class="bi bi-printer"></i> Print
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Display selected users -->
  <!-- <p class="mt-3"><strong>Selected Users:</strong> {{ selectedUsers | json }}</p> -->
</div>

<!-- Bootstrap Modal -->
<div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Products Ordered by User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <app-orders [itemsList]="itemList"></app-orders>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="printModal" tabindex="-1" aria-labelledby="modalPrint" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalPrint">Products Ordered by User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" *ngIf="openPrintDialog">
        <app-billing [billData]="selectedUser" [itemsList]="itemList" id="printArea"></app-billing>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" [useExistingCss]="true" printSectionId="printArea"
          ngxPrint>Print</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="printModalBulk" tabindex="-1" aria-labelledby="modalPrintBulk" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalPrintBulk">Products Ordered by User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" *ngIf="openBulkDialog && listOfObjects && listOfObjects.length>0">
        <app-packaging-group [labels]="isPrintLabels" [list]="listOfObjects" id="printAreaBulk"></app-packaging-group>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" [useExistingCss]="true" printSectionId="printAreaBulk"
          ngxPrint>Print</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="modalAddress" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAddress">Edit Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Address:
        <textarea [(ngModel)]="address" style="width: 100%;"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" (click)="editUser()">Update</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>